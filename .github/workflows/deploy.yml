name: ğŸŒŒ ULTRA +30 Jobs Deploy to GitHub Pages ğŸ˜âœ¨

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  NODE_VERSION: 20

jobs:
  # -----------------------
  # CORE PREP: detect html + pkg
  # -----------------------
  core_prep:
    name: ğŸ§  Core Prep & Detector
    runs-on: ubuntu-latest
    outputs:
      html_dir: ${{ steps.find_html.outputs.dir }}
      has_pkg: ${{ steps.find_pkg.outputs.exists }}
    steps:
      - name: ğŸ” Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ” Find package.json (safe)
        id: find_pkg
        run: |
          if [ -f package.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          echo "Found package.json? ${{ steps.find_pkg.outputs.exists }}" || true

      - name: ğŸ” Find first .html anywhere (safe)
        id: find_html
        run: |
          DIR=$(find . -name "*.html" -not -path "./node_modules/*" | head -n 1 | xargs dirname 2>/dev/null || true)
          if [ -z "$DIR" ]; then
            echo "âš ï¸ No HTML found, defaulting to repo root"
            DIR="."
          fi
          echo "dir=$DIR" >> $GITHUB_OUTPUT
          echo "HTML deploy dir => $DIR" || true

  # -----------------------
  # INSTALL STAGE
  # -----------------------
  install_stage:
    name: ğŸ“¦ Install Stage (safe)
    needs: core_prep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ npm install if package.json exists
        run: |
          if [ "${{ needs.core_prep.outputs.has_pkg }}" = "true" ]; then
            echo "â„¹ï¸ package.json detected â€” running npm install"
            npm install || echo "âš ï¸ npm install failed but continuing"
          else
            echo "â„¹ï¸ No package.json â€” skipping npm install"
          fi

  # -----------------------
  # BUILD STAGE
  # -----------------------
  build_stage:
    name: ğŸ—ï¸ Build Stage (safe)
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ§© Run build script if it exists
        run: |
          if npm run | grep -q "build"; then
            echo "ğŸ—ï¸ Running npm run build"
            npm run build || echo "âš ï¸ build failed or errored â€” continuing"
          else
            echo "â„¹ï¸ No build script found â€” skipping build"
          fi

  # -----------------------
  # DEV SANITY (short-lived)
  # -----------------------
  dev_sanity:
    name: â–¶ï¸ Dev Sanity Check (10s)
    needs: build_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: â–¶ï¸ Run npm run dev for a quick check (10s)
        run: |
          if npm run | grep -q "dev"; then
            echo "ğŸš€ Starting dev for 10 seconds (sanity)"
            timeout 10 npm run dev || echo "âš ï¸ dev exited or timed out â€” continuing"
          else
            echo "â„¹ï¸ No dev script â€” skipping dev run"
          fi

  # -----------------------
  # +30 COOL JOBS (safe echoes, checks, small tasks)
  # Each job uses only guarded run steps (|| true) so nothing stops the pipeline.
  # They all depend on install_stage so they run after packages installed.
  # -----------------------

  sparkle_01:
    name: âœ¨ Sparkle Sweep 01
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Echo sparkle
        run: echo "âœ¨ Sparkle Sweep 01 â€” vibes good" || true

  aurora_02:
    name: ğŸŒˆ Aurora Check 02
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Echo aurora
        run: echo "ğŸŒˆ Aurora Check 02 â€” colors OK" || true

  neon_03:
    name: ğŸ”® Neon Audit 03
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Echo neon
        run: echo "ğŸ”® Neon Audit 03 â€” neon stable" || true

  comet_04:
    name: â˜„ï¸ Comet Scan 04
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Echo comet
        run: echo "â˜„ï¸ Comet Scan 04 â€” fast check" || true

  starlit_05:
    name: ğŸŒŸ Starlit Smoke Test 05
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Echo star
        run: echo "ğŸŒŸ Starlit Smoke 05 â€” all bright" || true

  aurora_06:
    name: ğŸ”† Glow Patrol 06
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Glow
        run: echo "ğŸ”† Glow Patrol 06 â€” shimmer OK" || true

  ripple_07:
    name: ğŸŒŠ Ripple Check 07
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ripple
        run: echo "ğŸŒŠ Ripple Check 07 â€” waves smooth" || true

  ember_08:
    name: ğŸ”¥ Ember Quick 08
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ember
        run: echo "ğŸ”¥ Ember Quick 08 â€” heat stable" || true

  orbit_09:
    name: ğŸª Orbit Probe 09
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Orbit
        run: echo "ğŸª Orbit Probe 09 â€” trajectory OK" || true

  pixel_10:
    name: ğŸŸ£ Pixel Sweep 10
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Pixel
        run: echo "ğŸŸ£ Pixel Sweep 10 â€” pixels aligned" || true

  echo_11:
    name: ğŸ“£ Echo Loud 11
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Echo message
        run: echo "ğŸ“£ Echo Loud 11 â€” heard loud and clear" || true

  drift_12:
    name: ğŸŒ¬ï¸ Drift Whisper 12
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Drift
        run: echo "ğŸŒ¬ï¸ Drift Whisper 12 â€” breeze OK" || true

  prism_13:
    name: ğŸ”¸ Prism Flash 13
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prism
        run: echo "ğŸ”¸ Prism Flash 13 â€” refractions OK" || true

  nova_14:
    name: ğŸ’¥ Nova Ping 14
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Nova
        run: echo "ğŸ’¥ Nova Ping 14 â€” boom but safe" || true

  zenith_15:
    name: ğŸ§­ Zenith Patrol 15
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Zenith
        run: echo "ğŸ§­ Zenith Patrol 15 â€” heading true north" || true

  prism_16:
    name: âœ¨ Prism Glimmer 16
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prism glimmer
        run: echo "âœ¨ Prism Glimmer 16 â€” pretty" || true

  cascade_17:
    name: ğŸ’§ Cascade Blink 17
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cascade
        run: echo "ğŸ’§ Cascade Blink 17 â€” flowing" || true

  ember_18:
    name: ğŸ”¥ Ember Pulse 18
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ember pulse
        run: echo "ğŸ”¥ Ember Pulse 18 â€” pulse ok" || true

  echo_19:
    name: ğŸ“¡ Beacon Echo 19
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Beacon
        run: echo "ğŸ“¡ Beacon Echo 19 â€” pinged" || true

  drift_20:
    name: ğŸŒªï¸ Drift Burst 20
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Drift burst
        run: echo "ğŸŒªï¸ Drift Burst 20 â€” breeze strong" || true

  ember_21:
    name: ğŸ”¥ Ember Echo 21
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ember echo
        run: echo "ğŸ”¥ Ember Echo 21 â€” warm" || true

  aurora_22:
    name: ğŸŒ  Aurora Blink 22
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Aurora
        run: echo "ğŸŒ  Aurora Blink 22 â€” aurora stable" || true

  comet_23:
    name: â˜„ï¸ Comet Trace 23
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Comet trace
        run: echo "â˜„ï¸ Comet Trace 23 â€” trace OK" || true

  starlit_24:
    name: ğŸŒŸ Starlit Pulse 24
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Starlit pulse
        run: echo "ğŸŒŸ Starlit Pulse 24 â€” twinkle" || true

  ripple_25:
    name: ğŸŒŠ Ripple Echo 25
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ripple echo
        run: echo "ğŸŒŠ Ripple Echo 25 â€” calm" || true

  orbit_26:
    name: ğŸ›°ï¸ Orbit Check 26
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Orbit check
        run: echo "ğŸ›°ï¸ Orbit Check 26 â€” satellites nominal" || true

  pixel_27:
    name: ğŸŸ¦ Pixel Audit 27
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Pixel audit
        run: echo "ğŸŸ¦ Pixel Audit 27 â€” all pixels present" || true

  echo_28:
    name: ğŸ“£ Mega Echo 28
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Mega echo
        run: echo "ğŸ“£ Mega Echo 28 â€” broadcast OK" || true

  drift_29:
    name: ğŸŒ¬ï¸ Wind Whisper 29
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Wind whisper
        run: echo "ğŸŒ¬ï¸ Wind Whisper 29 â€” smooth" || true

  prism_30:
    name: ğŸ”¸ Prism Shine 30
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prism shine
        run: echo "ğŸ”¸ Prism Shine 30 â€” gleam" || true

  nova_31:
    name: ğŸ’« Nova Spark 31
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Nova spark
        run: echo "ğŸ’« Nova Spark 31 â€” tiny brilliance" || true

  zenith_32:
    name: ğŸ§­ Zenith Whisper 32
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Zenith whisper
        run: echo "ğŸ§­ Zenith Whisper 32 â€” direction true" || true

  cascade_33:
    name: ğŸ’¦ Cascade Murmur 33
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cascade murmur
        run: echo "ğŸ’¦ Cascade Murmur 33 â€” flowing fine" || true

  mercury_34:
    name: â˜€ï¸ Mercury Ping 34
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Mercury ping
        run: echo "â˜€ï¸ Mercury Ping 34 â€” hot but safe" || true

  lunar_35:
    name: ğŸŒ™ Lunar Lull 35
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lunar lull
        run: echo "ğŸŒ™ Lunar Lull 35 â€” calm night" || true

  aurora_36:
    name: ğŸŒŒ Aurora Finale 36
    needs: install_stage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Aurora finale
        run: echo "ğŸŒŒ Aurora Finale 36 â€” curtains" || true

  # -----------------------
  # FINAL DEPLOY (waits for core_prep + all checks above)
  # -----------------------
  deploy:
    name: ğŸŒ Deploy to GitHub Pages â€” Final Act
    needs:
      - core_prep
      - install_stage
      - build_stage
      - dev_sanity
      - sparkle_01
      - aurora_02
      - neon_03
      - comet_04
      - starlit_05
      - aurora_06
      - ripple_07
      - ember_08
      - orbit_09
      - pixel_10
      - echo_11
      - drift_12
      - prism_13
      - nova_14
      - zenith_15
      - prism_16
      - cascade_17
      - ember_18
      - echo_19
      - drift_20
      - ember_21
      - aurora_22
      - comet_23
      - starlit_24
      - ripple_25
      - orbit_26
      - pixel_27
      - echo_28
      - drift_29
      - prism_30
      - nova_31
      - zenith_32
      - cascade_33
      - mercury_34
      - lunar_35
      - aurora_36
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout (final)
        uses: actions/checkout@v4

      - name: ğŸ“¦ List deploy path
        run: |
          echo "HTML deploy dir = ${{ needs.core_prep.outputs.html_dir }}" || true

      - name: ğŸ“¦ Upload Pages artifact (deploy dir)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ needs.core_prep.outputs.html_dir }}

      - name: ğŸš€ Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: ğŸ§¾ Post-deploy: try npm install & dev (safe)
        run: |
          if [ "${{ needs.core_prep.outputs.has_pkg }}" = "true" ]; then
            echo "ğŸ“¥ Running post-deploy npm install (safe)"
            npm install || echo "âš ï¸ post-deploy npm install failed â€” continuing"
            if npm run | grep -q "dev"; then
              echo "â–¶ï¸ Attempting a short npm run dev for logs (10s)"
              timeout 10 npm run dev || echo "âš ï¸ post-deploy dev timed out or failed â€” continuing"
            else
              echo "â„¹ï¸ No dev script to run post-deploy"
            fi
          else
            echo "â„¹ï¸ No package.json â€” skipping post-deploy npm actions"
          fi

      - name: ğŸ‰ Done â€” Ultra +30 pipeline finished
        run: echo "âœ… All done. GitHub Pages deployed. Stay cool ğŸ˜" || true

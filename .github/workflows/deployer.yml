name: ğŸš€ Ultra Cool Auto Deploy Pipeline ğŸ˜ğŸ”¥

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸŒ Build â€¢ Test â€¢ Deploy â€¢ Dev

    steps:
      - name: ğŸ§² Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  Show system info
        run: |
          echo "ğŸ–¥ï¸ OS:" && uname -a
          echo "ğŸŸ¢ Node:" && node -v || true
          echo "ğŸ“¦ NPM:" && npm -v || true

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“‚ List project files
        run: ls -la

      - name: ğŸ“„ Detect package.json
        id: pkg
        run: |
          if [ -f package.json ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ Install dependencies (if available)
        if: steps.pkg.outputs.exists == 'true'
        run: npm install || echo "âš ï¸ npm install failed, skipping"

      - name: ğŸ§ª Run tests (if script exists)
        if: steps.pkg.outputs.exists == 'true'
        run: npm test || echo "âš ï¸ No tests or failed, skipping"

      - name: ğŸ§¹ Run lint (if exists)
        if: steps.pkg.outputs.exists == 'true'
        run: npm run lint || echo "âš ï¸ No lint script, skipping"

      - name: ğŸ—ï¸ Run build (if exists)
        if: steps.pkg.outputs.exists == 'true'
        run: npm run build || echo "âš ï¸ No build script, skipping"

      - name: ğŸ–¼ï¸ Validate HTML files
        run: |
          if ls *.html 1> /dev/null 2>&1; then
            echo "âœ… HTML files found"
          else
            echo "âš ï¸ No HTML files found"
          fi

      - name: ğŸ¨ Validate CSS files
        run: |
          if find . -name "*.css" | grep .; then
            echo "âœ… CSS files found"
          else
            echo "âš ï¸ No CSS files found"
          fi

      - name: âš¡ Validate JS files
        run: |
          if find . -name "*.js" | grep .; then
            echo "âœ… JS files found"
          else
            echo "âš ï¸ No JS files found"
          fi

      - name: ğŸ“¦ Prepare GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Deployment success message
        run: echo "ğŸš€ DEPLOYED SUCCESSFULLY TO GITHUB PAGES!"

      - name: ğŸ” Re-install npm globally (why not ğŸ˜)
        run: npm install -g npm || echo "âš ï¸ npm global install skipped"

      - name: ğŸ“¦ npm install (post-deploy)
        if: steps.pkg.outputs.exists == 'true'
        run: npm install || echo "âš ï¸ Post-deploy npm install skipped"

      - name: ğŸŸ¢ Run dev server (post-deploy)
        if: steps.pkg.outputs.exists == 'true'
        run: npm run dev || echo "âš ï¸ No dev script, skipping"

      - name: ğŸ§¾ Final status
        run: |
          echo "âœ… Workflow completed"
          echo "ğŸ˜ Repo deployed + dev attempted"
          echo "ğŸ”¥ You cooked"
